<div th:fragment="content(template,pageTitle, active)">
    <!--SUMMERNOTE -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>
<div class="container mt-5">
    <hr>
    <div id="result" class="mt-3"></div>
    <br>
    <input type="hidden" id="id" name="id" th:value="${template.getId()}">
    <input type="hidden" id="tenant" name="tenant" th:value="${template.getTenant().getName()}">
    <div class="input-group mb-3">
        <span class="input-group-text" id="inputGroup-sizing-sm6">Nome</span>
        <input type="text" id="name" class="form-control" name="name" th:value="${template.getName()}" placeholder="Nome template" aria-label="Small" aria-describedby="inputGroup-sizing-sm6">
        <span class="input-group-text" id="inputGroup-sizing-sm1">Versione</span>
        <input type="text" id="version" class="form-control" placeholder="Versione" th:value="${template.getVersion()}" name="version" aria-label="Small" aria-describedby="inputGroup-sizing-sm1">
    </div>
    <div class="input-group mb-3">
        <span class="input-group-text" id="inputGroup-sizing-sm4">Template Html</span>
        <textarea id="html" th:text="${template.getHtml()}" class="form-control" name="html" aria-label="Small" rows="10" cols="18" aria-describedby="inputGroup-sizing-sm4"></textarea>
    </div>
    <div class="input-group mb-3">
        <span class="input-group-text" id="inputGroup-sizing-sm5">Variabili JSON</span>
        <div id="jsonEditor"  style="height:320px;width:1200px;border:1px solid #dee2e6;border-radius:.375rem;"></div>
        <!-- textarea nascosta che verrà inviata al server -->
        <textarea id="variablesUserJson" th:text="${template.getUserVarSchema()}" name="user_vars_schema" hidden></textarea>
    </div>
    <div class="input-group mb-3">
        <div class="form-check">
            <label class="form-check-label" for="active">
                Attivo
            </label>
            <input class="form-check-input sm-4" type="checkbox" id="active" name="active" th:checked="${template.isActive()}">
        </div>
    </div>
    <div>
        <button id="btn1" class="btn btn-outline-primary gap-2" onclick="updateTemplate()">Aggiorna Template</button>
    </div>
    <br>
</div>
    <script>
        $('#html').summernote({
            height: 500,
            width: 1200,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold','italic','underline','clear']],
                ['para', ['ul','ol','paragraph']],
                ['insert', ['link','picture','table','hr']],
                ['view', ['codeview','fullscreen']]
            ],
            callbacks: {
                // facoltativo: impedisci che Summernote "sporchi" i tuoi placeholder
                onPaste: function(e) {
                    // esempio: incolla solo testo semplice
                    // e.preventDefault();
                    // const text = (e.originalEvent || e).clipboardData.getData('text/plain');
                    // document.execCommand('insertText', false, text);
                }
            }
        });
    </script>
    <script>
        // 1) Crea l'editor
        const container = document.getElementById('jsonEditor');
        const editor = new JSONEditor(container, {
            mode: 'code',      // 'code' (testo), 'tree' (ad albero) o 'form'
            mainMenuBar: false // opzionale, interfaccia più pulita
        });

        // 2) Carica un valore iniziale dalla textarea (se presente)
        (function preloadFromTextarea() {
            const ta = document.getElementById('variablesUserJson');
            if (!ta.value || ta.value.trim() === '') {
                // default iniziale sensato
                editor.set({
                    ownerName: { type: 'string', label: 'Intestatario', required: true },
                    courseName: { type: 'string', label: 'Nome corso', required: true },
                    hours: { type: 'number', label: 'Ore', default: 12 },
                    grade: { type: 'string', enum: ['A','B','C'] }
                });
            } else {
                try {
                    editor.set(JSON.parse(ta.value));
                } catch (e) {
                    // Se il JSON salvato era corrotto, mostra comunque il raw
                    editor.updateText(ta.value);
                }
            }
        })();

        // 3) Sync su submit del form → scrivi JSON “pulito” nella textarea
        document.getElementById('btn1').addEventListener('submit', (ev) => {
            try {
                const json = editor.get();                  // ottieni l’oggetto
                document.getElementById('variablesUserJson').value = JSON.stringify(json);
            } catch (err) {
                ev.preventDefault(); // blocca il submit se JSON non valido
                alert('JSON non valido: ' + err.message);
            }
        });

        // 4) (Opzionale) Sync live mentre l’utente digita, utile se hai anteprima
        //    Attenzione: fai debounce per non stressare la pagina
        let t;
        editor.on('change', () => {
            clearTimeout(t);
            t = setTimeout(() => {
                try {
                    const json = editor.get();
                    document.getElementById('variablesUserJson').value = JSON.stringify(json);
                } catch (_) {
                    // in modalità "code" può essere temporaneamente invalido: ignora
                }
            }, 300);
        });
    </script>
<script>
    async function updateTemplate() {
        try {
            const API_BASE = "/api/admin/templates";
            const name = document.getElementById("name").value.trim();
            const id = document.getElementById("id").value.trim();
            const version = document.getElementById("version").value.trim();
            const html = document.getElementById("html").value.trim();
            const variablesUserJson = document.getElementById("variablesUserJson").value.trim();
            const active = document.getElementById("active").checked;
            const response = await fetch(`${API_BASE}/${id}/edit`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    id: id,
                    name: name,
                    version: version,
                    html: html,
                    variablesUserJson: variablesUserJson,
                    active: active
                })
            });
            const resultDiv = document.getElementById("result");
            const data = await response.json();
            if (!response.ok) {
                // Esempio: mostra il primo errore per campo
                const errors = data.errors || {};
                alert(Object.entries(errors).map(([field, msgs]) => `${field}: ${msgs[0]}`).join("\n"));
                return;
            } else {
                resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ✅ <b>Template aggiornato con successo</b><br>
                    <b>ID:</b> ${data.id}<br>
                    <b>Nome:</b> ${data.name}<br>
                    <b>Versione:</b> ${data.version}<br>
                    <b>Attivo:</b> ${data.active}<br>
                    <b>Nome tenant:</b> ${data.tenant}<br>
                </div>
            `;
            }
        }
        catch (error) {
            console.error("Errore durante l'aggiornamento del template:", error);
            showToast(error.message)
        }
    }
</script>
<script>
    function showToast(message) {
        const toastEl = document.getElementById('appToast');
        toastEl.querySelector('.toast-body').textContent = message;
        const t = bootstrap.Toast.getOrCreateInstance(toastEl);
        t.show();
    }
</script>
</div>