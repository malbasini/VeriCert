<div th:fragment="content(template,pageTitle, active)">
<br>
<div class="container mt-5">
    <hr>
    <div id="result" class="mt-3"></div>
    <br>
    <input type="hidden" id="id" name="id" th:value="${template.getId()}">
    <input type="hidden" id="tenant" name="tenant" th:value="${template.getTenant().getName()}">
    <div class="input-group mb-3">
        <span class="input-group-text" id="inputGroup-sizing-sm6">Nome</span>
        <input type="text" id="name" class="form-control" name="name" th:value="${template.getName()}" placeholder="Nome template" aria-label="Small" aria-describedby="inputGroup-sizing-sm6">
        <span class="input-group-text" id="inputGroup-sizing-sm1">Versione</span>
        <input type="text" id="version" class="form-control" placeholder="Versione" th:value="${template.getVersion()}" name="version" aria-label="Small" aria-describedby="inputGroup-sizing-sm1">
    </div>
    <div class="input-group mb-3">
        <span class="input-group-text" id="inputGroup-sizing-sm4">Html</span>
        <textarea id="html" th:text="${template.getHtml()}" class="form-control" name="html" aria-label="Small" rows="10" cols="18" aria-describedby="inputGroup-sizing-sm4"></textarea>
    </div>
    <div class="input-group mb-3">
        <span class="input-group-text" id="inputGroup-sizing-sm5">Variabili JSON</span>
        <textarea id="variablesUserJson" th:text="${template.getUserVarSchema()}" class="form-control" name="variablesJson" aria-label="Small" rows="10" cols="18" aria-describedby="inputGroup-sizing-sm4"></textarea>
    </div>
    <div class="input-group mb-3">
        <div class="form-check">
            <label class="form-check-label" for="active">
                Attivo
            </label>
            <input class="form-check-input sm-4" type="checkbox" id="active" name="active" th:checked="${template.isActive()}">
        </div>
    </div>
    <div>
        <button class="btn btn-outline-primary gap-2" onclick="updateTemplate()">Aggiorna Template</button>
    </div>
    <br>
</div>
<script>
    async function updateTemplate() {
        try {
            const API_BASE = "/api/admin/templates";
            const name = document.getElementById("name").value.trim();
            const id = document.getElementById("id").value.trim();
            const version = document.getElementById("version").value.trim();
            const html = document.getElementById("html").value.trim();
            const variablesUserJson = document.getElementById("variablesUserJson").value.trim();
            const active = document.getElementById("active").checked;
            const response = await fetch(`${API_BASE}/${id}/edit`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    id: id,
                    name: name,
                    version: version,
                    html: html,
                    variablesUserJson: variablesUserJson,
                    active: active
                })
            });
            const resultDiv = document.getElementById("result");
            const data = await response.json();
            if (!response.ok) {
                // Esempio: mostra il primo errore per campo
                const errors = data.errors || {};
                alert(Object.entries(errors).map(([field, msgs]) => `${field}: ${msgs[0]}`).join("\n"));
                return;
            } else {
                resultDiv.innerHTML = `
                <div class="alert alert-success">
                    âœ… <b>Template aggiornato con successo</b><br>
                    <b>ID:</b> ${data.id}<br>
                    <b>Nome:</b> ${data.name}<br>
                    <b>Versione:</b> ${data.version}<br>
                    <b>Attivo:</b> ${data.active}<br>
                    <b>Nome tenant:</b> ${data.tenant}<br>
                </div>
            `;
            }
        }
        catch (error) {
            console.error("Errore durante l'aggiornamento del template:", error);
            showToast(error.message)
        }
    }
</script>
<script>
    function showToast(message) {
        const toastEl = document.getElementById('appToast');
        toastEl.querySelector('.toast-body').textContent = message;
        const t = bootstrap.Toast.getOrCreateInstance(toastEl);
        t.show();
    }
</script>
</div>