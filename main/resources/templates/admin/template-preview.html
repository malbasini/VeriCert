<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Template Preview · VeriCert</title>
</head>
<body class="bg-light">
<div th:replace="common/base :: headerFragment"></div>

<div class="container py-4">
    <h2 class="mb-4">Anteprima Template</h2>

    <!-- Select Template ID -->
    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label">Template ID</label>
            <input id="tplId" type="number" class="form-control" placeholder="es. 1">
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-secondary" onclick="loadVars()">Carica variabili richieste</button>
        </div>
    </div>

    <!-- Required vars -->
    <div class="mt-3">
        <label class="form-label">Variabili richieste (dal template)</label>
        <div id="requiredVars" class="alert alert-info py-2 mb-0">—</div>
    </div>

    <!-- Vars JSON -->
    <div class="mt-3">
        <label class="form-label">Vars (JSON)</label>
        <textarea id="varsJson" class="form-control" rows="8" spellcheck="false">
{
  "ownerName": "Mario Rossi",
  "courseName": "Spring Boot",
  "hours": "12",
  "grade": "A"
}
    </textarea>
    </div>

    <div class="mt-3 d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="checkVars()">Controlla variabili</button>
        <button class="btn btn-primary" onclick="preview()">Anteprima</button>
    </div>

    <!-- Preview -->
    <div class="mt-4">
        <h5>Risultato</h5>
        <div id="msg"></div>
        <iframe id="previewFrame" class="w-100" style="height:600px;border:1px solid #dee2e6;background:white;"></iframe>
    </div>
</div>

<script>
    const API = "/api/templates";

    function showMessage(html, cls="info") {
        document.getElementById("msg").innerHTML = `<div class="alert alert-${cls}">${html}</div>`;
    }

    async function loadVars() {
        const id = document.getElementById("tplId").value;
        if (!id) return showMessage("Inserisci un Template ID", "warning");
        const res = await fetch(`${API}/${id}/variables`);
        if (!res.ok) return showMessage("Impossibile leggere le variabili", "danger");
        const data = await res.json();
        document.getElementById("requiredVars").textContent = (data.required || []).join(", ") || "—";
        showMessage("Variabili caricate", "success");
    }

    async function checkVars() {
        const id = document.getElementById("tplId").value;
        if (!id) return showMessage("Inserisci un Template ID", "warning");
        let vars;
        try { vars = JSON.parse(document.getElementById("varsJson").value); }
        catch { return showMessage("JSON non valido nelle vars", "danger"); }

        const res = await fetch(`${API}/${id}/check-variables`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(vars)
        });
        const data = await res.json();
        if (res.ok && data.ok) showMessage("Tutte le variabili richieste sono presenti ✅", "success");
        else showMessage(`Mancano: <b>${(data.missing || []).join(", ")}</b>`, "warning");
    }

    async function preview() {
        const id = document.getElementById("tplId").value;
        if (!id) return showMessage("Inserisci un Template ID", "warning");
        let vars;
        try { vars = JSON.parse(document.getElementById("varsJson").value); }
        catch { return showMessage("JSON non valido nelle vars", "danger"); }

        const res = await fetch(`${API}/${id}/preview`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(vars)
        });
        if (!res.ok) return showMessage("Errore durante l'anteprima", "danger");
        const data = await res.json();
        const frame = document.getElementById("previewFrame");
        frame.srcdoc = data.html || "<p>Nessun contenuto</p>";
        showMessage("Anteprima aggiornata ✅", "success");
    }
</script>
<div th:replace="common/base :: headerFragment"></div>
<!-- qui potresti caricare i file JS di Bootstrap, se serve -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>