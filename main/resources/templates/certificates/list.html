<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <meta charset="UTF-8"><title>Template · VeriCert</title>
</head>
<body>
<div th:replace="common/base :: headerFragment"></div>
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Certificati</span>
        <div class="input-group input-group-sm" style="max-width: 320px;">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="q" class="form-control" placeholder="Cerca…">
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light position-sticky top-0">
            <tr>
                <th>ID</th>
                <th>Seriale</th>
                <th>Owner</th>
                <th>Stato</th>
                <th>Azioni</th>
            </tr>
            </thead>
            <tbody id="rows">
            <!-- righe via JS -->
            </tbody>
        </table>
    </div>

    <div class="card-footer d-flex justify-content-between align-items-center">
        <small class="text-body-secondary">Totale: <span id="total">0</span></small>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <!-- costruisci la paginazione da Page<T> -->
            </ul>
        </nav>
    </div>
</div>
<br>
<hr>
<div id="result"></div>
<script>

    async function load() {
        const tbody = document.getElementById('rows');
        tbody.innerHTML = '';
        try {
            const res = await fetch('/api/certificates/list', { headers: { 'Accept': 'application/json' } });
            // 1) non ok -> mostra errore
            if (!res.ok) {
                const text = await res.text().catch(() => '');
                // se è una pagina HTML (login), avvisa
                const ct = res.headers.get('Content-Type') || '';
                if (ct.includes('text/html')) {
                    return;
                }
                return;
            }
            // 2) content-type deve essere JSON
            const ct = (res.headers.get('Content-Type') || '').toLowerCase();
            if (!ct.includes('application/json')) {
                const text = await res.text().catch(() => '');
                console.error('Risposta non-JSON:', text);
                return;
            }
            // 3) parse sicuro
            let page;
            try {
                page = await res.json();
            } catch (e) {
                const raw = await res.text().catch(()=>'');
                console.error('JSON parse error. Body:', raw);
                return;
            }
            // 4) struttura attesa: { content: [...] }
            const items = Array.isArray(page.content) ? page.content : [];
            if (items.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="text-center py-5 text-body-secondary">
                                    <i class="bi bi-inbox me-1"></i> Nessun dato disponibile
                                 </td>`
                return tbody.appendChild(tr);
            }
            // 5) render righe
            for (const t of items) {
                const revoked = String(t.status).toUpperCase() === 'REVOKED';
                const badgeClass = revoked ? 'text-bg-danger' : 'text-bg-success';
                const badgeText  = revoked ? 'Revocato'         : 'Valido';
                const tr = document.createElement('tr');
                tr.innerHTML = `
           <td>${t.id ?? ''}</td>
           <td>${t.serial ?? ''}</td>
           <td>${t.owner ?? ''}</td>
           <td>
           <span class="badge rounded-pill ${badgeClass}">${badgeText}</span>
           </td>
          <td>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.open('${encodeURI(t.pdfUrl)}','_blank','noopener')">Apri</button>
          </td>`
                tbody.appendChild(tr);
            }
            let total = document.getElementById('total');
            total.innerHTML = `${items.length}`;
        } catch (err) {
            console.error(err);
        }
    }
    // avvia al DOM pronto
    document.addEventListener('DOMContentLoaded', load);
</script>
</body>
<div th:replace="common/footer :: footerFragment"></div>
<!-- qui potresti caricare i file JS di Bootstrap, se serve -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</html>
