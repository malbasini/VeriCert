<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Revoca certificato</title>
</head>
<body>
<!-- Inclusione dell'header -->
<div th:replace="common/base :: headerFragment"></div>
<div class="container mt-5">
    <h2 class="mb-3">Revoca certificato</h2>
    <div class="input-group mb-3">
        <label class="input-group-text" for="codeSelect">Codice</label>
        <select class="form-select" id="codeSelect">
            <option value="">-- Seleziona un certificato --</option>
        </select>
        <label class="input-group-text" for="tenantName">Tenant</label>
        <input type="text" class="form-control" id="tenantName" placeholder="Tenant" th:value="${tenantName}" aria-label="Tenant" aria-describedby="tenantName" readonly="readonly">
        <label class="input-group-text" for="reason">Motivo della revoca</label>
        <input type="text" class="form-control" id="reason" placeholder="Motivo della revoca" aria-label="Motivo" aria-describedby="Motivo">
        <button class="btn btn-primary" onclick="revoke()">Revoca cerificato</button>
    </div>
    <br>
    <hr>
    <div id="result" class="mt-3"></div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api/certificates";

    // Popola la select all'avvio
    async function loadCodes() {
        const response = await fetch(`${API_BASE}/codes`);
        const codes = await response.json();
        const select = document.getElementById("codeSelect");

        codes.forEach(code => {
            const option = document.createElement("option");
            option.value = code;
            option.textContent = code;
            select.appendChild(option);
        });
    }

    // Revoca certificato selezionato
    async function revoke() {
        const code = document.getElementById("codeSelect").value;
        if (!code) {
            alert("Seleziona un codice valido");
            return;
        }
        const tenantName = document.getElementById("tenantName").value;
        const reason = document.getElementById("reason").value;
        const body = { reason: reason || "Revocato da test.html" };
        const response = await fetch(`${API_BASE}/${code}/revoke`, {

            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Tenant":tenantName
            },
            body: JSON.stringify(body)
        });
        const resultDiv = document.getElementById("result");

        if (response.ok) {
            const data = await response.json();
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ✅ <b>Certificato revocato</b><br>
                    <b>Proprietario:</b> ${data.ownerName}<br>
                    <b>Email:</b> ${data.ownerEmail}<br>
                    <b>Corso:</b> ${data.courseCode}<br>
                    <b>Motivo revoca:</b> ${data.revokedReason}<br>
                    <b>Data della revoca:</b> ${data.revokedAt}<br>
                </div>
            `;
        } else if (response.status === 410) {
            resultDiv.innerHTML = `<div class="alert alert-warning">⚠️ Certificato revocato</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">❌ Certificato non trovato</div>`;
        }
    }

    // carica i codici al caricamento della pagina
    loadCodes();
</script>
</body>
</html>