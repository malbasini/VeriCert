<!-- Dettaglio certificato (semplice, read-only) -->
<div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h4 mb-0">Dettaglio certificato</h2>
        <a class="btn btn-outline-secondary" th:href="@{/admin/certificates}">
            <i class="bi bi-arrow-left"></i> Torna alla lista
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Header: stato + seriale -->
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
          <span class="badge"
                th:classappend="${certificate.status.name()=='REVOKED'} ? ' text-bg-danger' : ' text-bg-success'"
                th:text="${certificate.status}">ISSUED</span>
                    <span class="text-muted">Seriale:</span>
                    <span class="fw-semibold" th:text="${certificate.serial}">ABC123</span>
                </div>
                <small class="text-muted">
                    Tenant: <span th:text="${currentTenant}">demo</span>
                </small>
            </div>

            <hr/>

            <!-- Metadati principali (solo lettura) -->
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="form-floating">
                        <input class="form-control" readonly th:value="${certificate.ownerName}">
                        <label>Intestatario</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <input class="form-control" readonly th:value="${certificate.ownerEmail}">
                        <label>Email intestatario</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <input class="form-control" readonly th:value="${certificate.templateName}">
                        <label>Template</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <input class="form-control" readonly
                               th:value="${#temporals.format(certificate.issuedAt,'dd/MM/yyyy HH:mm')}">
                        <label>Emesso il</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <input class="form-control" readonly th:value="${certificate.verifyUrl}">
                        <label>Verifica pubblica</label>
                    </div>
                    <div class="mt-1">
                        <a class="btn btn-sm btn-outline-secondary" th:href="${certificate.verifyUrl}" target="_blank">
                            Apri verifica
                        </a>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <input class="form-control" readonly th:value="${certificate.pdfUrl}">
                        <label>PDF</label>
                    </div>
                    <div class="mt-1">
                        <a class="btn btn-sm btn-outline-secondary" th:href="@{${certificate.pdfUrl}}" target="_blank">
                            Apri PDF
                        </a>
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="form-floating">
                        <input class="form-control font-monospace" readonly th:value="${certificate.sha256}">
                        <label>SHA-256</label>
                    </div>
                </div>
            </div>

            <hr/>

            <!-- Variabili utente (dinamiche, read-only) -->
            <h5 class="mb-3">Variabili utente</h5>

            <!-- Mettiamo i JSON in <script type="application/json"> per non scappare i caratteri -->
            <!-- Valori variabili utente (quelli salvati sul certificato) -->
            <script id="userVarsData" type="application/json" th:utext="${userVarsJson}">{}</script>
            <!-- Schema del template (per label/type/hint opzionali) -->
            <script id="userVarsSchema" type="application/json" th:utext="${userVarsSchemaJson}">{}</script>

            <div id="userVarsView" class="row g-3"></div>

        </div>
    </div>
</div>

<!-- Render dinamico read-only -->
<script>
    (function renderUserVars(){
        const dataTag   = document.getElementById('userVarsData');
        const schemaTag = document.getElementById('userVarsSchema');

        let data = {};
        let schema = {};
        try { data = JSON.parse(dataTag?.textContent || '{}'); } catch(_){}
        try { schema = JSON.parse(schemaTag?.textContent || '{}'); } catch(_){}

        const root = document.getElementById('userVarsView');
        if (!root) return;

        // Se hai uno schema, usalo per ordinare e dare label; altrimenti mostra tutte le chiavi di data
        const entries = [];
        if (schema && typeof schema === 'object' && !Array.isArray(schema)) {
            for (const [name, spec] of Object.entries(schema)) {
                entries.push({ name, label: spec?.label || name, type: spec?.type || 'text', value: data?.[name] });
            }
            // Eventuali chiavi “extra” presenti nei dati ma non nello schema
            for (const k of Object.keys(data)) {
                if (!entries.find(e => e.name === k)) {
                    entries.push({ name:k, label:k, type: typeof data[k], value: data[k] });
                }
            }
        } else {
            for (const [k, v] of Object.entries(data)) {
                entries.push({ name:k, label:k, type: typeof v, value: v });
            }
        }

        // Render a griglia di floating-readonly
        for (const e of entries) {
            const col = document.createElement('div');
            col.className = 'col-md-4';
            const wrap = document.createElement('div');
            wrap.className = 'form-floating';

            const input = document.createElement('input');
            input.className = 'form-control';
            input.readOnly = true;
            input.value = formatValue(e.value);
            // metti monospace per valori non-triviali
            if (typeof e.value === 'object') input.classList.add('font-monospace');

            const label = document.createElement('label');
            label.textContent = e.label;

            wrap.append(input, label);
            col.append(wrap);
            root.append(col);
        }

        function formatValue(v){
            if (v == null) return '';
            if (typeof v === 'boolean') return v ? 'true' : 'false';
            if (typeof v === 'object')  return JSON.stringify(v);
            return String(v);
        }
    })();
</script>
