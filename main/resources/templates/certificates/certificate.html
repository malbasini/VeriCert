<!DOCTYPE html>
<html lang="it" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<!-- Inclusione dell'header -->
<head>
    <meta charset="UTF-8">
    <title>Test API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        h2 { color: #333; }
        .box { border: 1px solid #ccc; padding: 1rem; margin-bottom: 2rem; border-radius: 8px; }
        pre { background: #f4f4f4; padding: 1rem; border-radius: 5px; }
        input, button, textarea { margin-top: 0.5rem; padding: 0.4rem; width: 100%; }
        button { cursor: pointer; background: #007bff; color: #fff; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
<div th:replace="common/base :: headerFragment"></div>
<br>
    <div class="container mt-5">
        <h2 class="mb-3">Crea certificato</h2>
        <input type="hidden" id="userVarSchema" name="userVarSchema" th:value="${userVarSchema}">
        <input type="hidden" id="templateId" name="templateId" th:value="${templateId}">
        <input type="hidden" id="tenantName" name="tenantName" th:value="${tenantName}">
        <br>
        <hr>
        <div id="varsForm"></div>
        <br>
        <div class="input-group mb-3">
            <button class="btn btn-primary" onclick="createCert()">Crea cerificato</button>
        </div>
        <hr>
        <div id="result" class="mt-3"></div>
    </div>

<script>
    // Parsifica in sicurezza il JSON dello schema
    function parseSchema(sel = '#userVarSchema') {
        const el = document.querySelector(sel);
        if (!el) return {};
        try {
            const txt = (el.value ?? el.textContent ?? '').trim();
            return txt ? JSON.parse(txt) : {};
        } catch (e) {
            console.error('Schema JSON non valido:', e);
            return {};
        }
    }
    let schema = parseSchema('#userVarSchema');
    alert(schema);// <-- ORA è un oggetto
    function buildForm() {
        const root = document.getElementById('varsForm');
        root.innerHTML = ''; // evita duplicati

        // se per errore arriva un array, trasformalo in oggetto { field_i: spec }
        if (Array.isArray(schema)) {
            schema = schema.reduce((acc, spec, i) => (acc['field_' + i] = spec, acc), {});
        }
        for (const [name, specRaw] of Object.entries(schema)) {
            const spec = specRaw || {};
            const type = String(spec.type || 'string').toLowerCase();
            const wrap = document.createElement('div');
            wrap.className = type === 'boolean' || type === 'bool' ? 'mb-3 form-check' : 'mb-3';
            const label = document.createElement('label');
            label.className = type === 'boolean' || type === 'bool' ? 'form-check-label' : 'form-label';
            label.htmlFor = `f_${name}`;
            label.textContent = spec.label || name;
            if (type === 'boolean' || type === 'bool') {
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.id = `f_${name}`;
                cb.name = name;
                cb.className = 'form-check-input';
                cb.required = !!spec.required;
                if (spec.default === true) cb.checked = true;
                wrap.append(cb, label); // checkbox prima, etichetta dopo (bootstrap)
                root.append(wrap);
                continue;
            }
            const input = document.createElement(
                type === 'date' ? 'input' :
                    type === 'number' ? 'input' : 'input'
            );
            input.className = 'form-control';
            input.id = `f_${name}`;
            input.name = name;
            input.required = !!spec.required;
            input.type = (type === 'number') ? 'number' :
                (type === 'date') ? 'date' : 'text';
            if (spec.default != null) input.value = spec.default;
            wrap.append(label, input);
            root.append(wrap);
        }
    }
    function collect(rootSelector = '#varsForm', schema = null) {
        const root = document.querySelector(rootSelector);
        if (!root) throw new Error(`Container ${rootSelector} non trovato`);
        const data = Object.create(null);
        const fields = root.querySelectorAll('input[name], select[name], textarea[name]');
        for (const el of fields) {
            const name = el.name;
            if (!name) continue;
            const spec = schema?.[name] || {};
            const type = String(spec.type || el.type || 'text').toLowerCase();
            if (el.type === 'checkbox') {
                const group = root.querySelectorAll(`input[type="checkbox"][name="${CSS.escape(name)}"]`);
                if (group.length > 1) {
                    data[name] ??= [];
                    if (el.checked) data[name].push(el.value);
                } else {
                    data[name] = !!el.checked;
                }
                continue;
            }
            if (el.type === 'radio') {
                if (data[name] !== undefined) continue;
                const checked = root.querySelector(`input[type="radio"][name="${CSS.escape(name)}"]:checked`);
                data[name] = checked ? checked.value : (spec.default ?? '');
                continue;
            }
            if (el.tagName === 'SELECT' && el.multiple) {
                const arr = [...el.selectedOptions].map(o => o.value);
                data[name] = arr.length ? arr : (spec.default ?? []);
                continue;
            }
            const raw = (el.value ?? '').trim();
            if (type === 'number' || el.type === 'number') {
                // vuoto -> default o null; non fare Number("")!
                if (raw === '') {
                    data[name] = spec.default ?? null;       // <-- qui il fallback
                } else {
                    const n = Number(raw);
                    data[name] = Number.isNaN(n) ? (spec.default ?? null) : n;
                }
                continue;
            }
            // boolean da select/text? (raro) -> normalizza
            if (type === 'boolean' || type === 'bool') {
                data[name] = raw === '' ? (spec.default ?? false) : (raw === 'true' || raw === '1' || raw === 'on');
                continue;
            }
            // default testo
            data[name] = raw === '' ? (spec.default ?? '') : raw;
        }
        return data;
    }
    async function createCert() {
        alert("Creazione certificato");
        const API_BASE = "/api";
        const templateId = document.getElementById("templateId").value.trim();
        alert(templateId);
        const tenantName = document.getElementById("tenantName").value.trim();
        alert(tenantName);
        const vars = collect();
        const response = await fetch(`${API_BASE}/certificates/${templateId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Tenant": tenantName
            },
            body: JSON.stringify(vars)
        });
        const resultDiv = document.getElementById("result");
        const data = await response.json();
        if(!response.ok)
        {
                // Esempio: mostra il primo errore per campo
                const errors = data.errors || {};
                alert(Object.entries(errors).map(([field, msgs]) => `${field}: ${msgs[0]}`).join("\n"));
                return;
        }
        else
        {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ✅ <b>Certificato creato con successo</b><br>
                    <b>ID:</b> ${data.code}<br>
                    <b>Serial:</b> ${data.serial}<br>
                    <b>PDF Url:</b> ${data.pdfUrl}<br>
                    <b>PDF Sha256:</b> ${data.sha256}<br>
                    <b>Proprietario:</b> ${data.ownerName}<br>
                    <b>Email:</b> ${data.ownerEmail}<br>
                    <b>Emesso in data:</b> ${data.issuedAt}<br>
                </div>
            `;
        }
    }
    // Costruisci il form UNA SOLA VOLTA
    document.addEventListener('DOMContentLoaded', buildForm);
    document.querySelector('form')?.addEventListener('submit', e => e.preventDefault());
</script>
</body>
<div th:insert="common/footer :: footerFragment"></div>
<!-- qui potresti caricare i file JS di Bootstrap, se serve -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</html>
