<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/html">
<div th:fragment="content(pageTitle, active)">
    <body>
    <div class="container mt-5">
        <hr>
        <div id="result" class="mt-3"></div>
        <br>
        <div class="btn-group" role="group" aria-label="Azioni">
            <a class="btn btn-outline-secondary me-3 rounded"
               th:href="@{/admin/templates}">
                <i class="bi bi-arrow-left me-1"></i> Torna alla lista
            </a>
            <a class="btn btn-outline-secondary rounded"
               th:href="@{/admin}">
                <i class="bi bi-speedometer2 me-2"></i> Torna alla dashboard
            </a>
        </div>
        <br>
        <br>
        <br>
        <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-sm6">Nome</span>
            <input type="text" id="name" class="form-control" name="name" placeholder="Nome template" aria-label="Small" aria-describedby="inputGroup-sizing-sm6">
            <span class="input-group-text" id="inputGroup-sizing-sm1">Versione</span>
            <input type="text" id="version" class="form-control" placeholder="Versione" name="version" aria-label="Small" aria-describedby="inputGroup-sizing-sm1">
        </div>
        <div class="input-group mb-3">
            <span class="input-group-text">Template Html</span>
            <div class="form-control p-0">
                <div id="html" style="height:520px;"></div><!--Editor host -->
                <input type="hidden" id="htmlHidden" name="html">
            </div>
        </div>
        <div class="input-group mb-3">
            <span class="input-group-text">Variabili JSON</span>
            <div class="form-control p-0">
                <div id="jsonEditor" class="w-100" style="height:320px;border:1px solid #dee2e6;border-radius:.375rem;"></div>
            </div>
            <label for="variablesUserJson"></label><textarea id="variablesUserJson" name="user_vars_schema" hidden></textarea>
        </div>

        <div class="input-group mb-3">
            <div class="form-check">
                <label class="form-check-label" for="active">
                    Active
                </label>
                <input class="form-check-input sm-4" type="checkbox" id="active" name="active">
            </div>
        </div>
        <div class="input-group mb-3">
            <div class="row">
                <div class="col-md-4"></div>
                <div class="col-md4">
                    <div class="g-recaptcha" id="g-recaptcha" th:attr="data-sitekey=${@captchaSettings.getSite()}"></div>
                </div>
                <div class="col-md-4"></div>
            </div>
        </div>
        <div class="input-group mb-3">
            <button id="btn1" class="btn btn-outline-primary">Salva</button>
        </div>
    </div>
    <!-- Monaco loader (LOCALE) -->
    <script src="/vendor/monaco-editor/min/vs/loader.js"></script>
    <script>
        // Base locale
        require.config({ paths: { 'vs': '/vendor/monaco-editor/min/vs' } });

        const base = window.location.origin + '/vendor/monaco-editor/min/';

        window.MonacoEnvironment = {
            getWorkerUrl: () =>
                'data:text/javascript;charset=utf-8,' + encodeURIComponent(`
        self.MonacoEnvironment = { baseUrl: '${base}' };
        importScripts('${base}vs/base/worker/workerMain.js');
      `)
        };

        document.addEventListener('DOMContentLoaded', function() {
            const ta = document.getElementById('html');

            // 1) crea un contenitore per Monaco subito dopo la textarea e nascondi la textarea
            const host = document.createElement('div');
            host.id = 'monacoHost';
            host.style.cssText = 'border:1px solid #dee2e6;border-radius:.375rem;height:520px;width:100%;';
            ta.style.display = 'none';
            ta.insertAdjacentElement('afterend', host);

            // 2) inizializza Monaco leggendo il valore ATTUALE della textarea (gi√† popolata lato server)
            require(['vs/editor/editor.main'], function () {
                const initial = ta.value ?? '';
                const editor = monaco.editor.create(host, {
                    value: initial,
                    language: 'html',
                    theme: 'vs',
                    automaticLayout: true,
                    minimap: {enabled: false},
                    wordWrap: 'on',
                    fontSize: 14,
                    tabSize: 2,
                    insertSpaces: true
                });
                window.monacoEditor = editor;

                // 3) al click ‚ÄúSalva‚Äù, copia il contenuto di Monaco DENTRO la textarea e fai submit/fetch
                document.getElementById('btn1')?.addEventListener('click', async (e) => {
                    e.preventDefault();
                    ta.value = editor.getValue();// üëà la textarea rimane la ‚Äúfonte della verit√†‚Äù per il backend
                    const json = jsonEditor.get();
                    document.getElementById('variablesUserJson').value = JSON.stringify(json);
                    // se usi fetch:
                    const payload = {
                        name: document.getElementById('name')?.value?.trim(),
                        version: document.getElementById('version')?.value?.trim(),
                        html: ta.value,  // üëà invariato per il controller
                        variablesUserJson: document.getElementById('variablesUserJson')?.value?.trim(),
                        active: document.getElementById('active')?.checked,
                        captchaToken: document.querySelector('textarea[name="g-recaptcha-response"]')?.value || ''
                    };
                    const res = await fetch('/api/admin/templates/new', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const contentType = res.headers.get('Content-Type') || '';
                    const data = contentType.includes('application/json') ? await res.json() : null;
                    if (!res.ok) {
                        if(data?.errors !== undefined) {
                            renderValidationErrors(data?.errors)
                            return;
                        }
                        else{
                            showToast(data?.message ,{ colorClass: 'bg-danger'})
                        }
                    }
                    showToast('Template creato', { colorClass: 'bg-success'});
                });
            });
        });
    </script>
    <script>
        function renderValidationErrors(errors) {
            if (!errors || typeof errors !== 'object') {
                showToast('Si √® verificato un errore di validazione.');
                return;
            }

            // Costruisci una UL con i messaggi
            const items = Object.entries(errors).flatMap(([field, messages]) => {
                const list = Array.isArray(messages) ? messages : [String(messages)];
                return list.map(msg => `<li>${escapeHtml(field)}: ${escapeHtml(msg)}</li>`);
            });
            const html = `
                        <div>
                          <strong>Validazione fallita</strong>
                          <ul class="mb-0 ps-3">
                            ${items.join('')}
                          </ul>
                        </div>
                      `;
            showToast(html, { colorClass: 'bg-danger'});
        }
        // Piccola funzione per evitare injection nell‚ÄôHTML del toast
        function escapeHtml(s) {
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }
    </script>
    <script>
        // 1) Crea l'editor
        const container = document.getElementById('jsonEditor');
        const jsonEditor = new JSONEditor(container, {
            mode: 'code',      // 'code' (testo), 'tree' (ad albero) o 'form'
            mainMenuBar: false // opzionale, interfaccia pi√π pulita
        });

        // 2) Carica un valore iniziale dalla textarea (se presente)
        (function preloadFromTextarea() {
            const ta = document.getElementById('variablesUserJson');
            if (!ta.value || ta.value.trim() === '') {
                // default iniziale sensato
                jsonEditor.set({
                    ownerName: {type: 'string', label: 'Intestatario', required: true},
                    courseName: {type: 'string', label: 'Nome corso', required: true},
                    hours: {type: 'number', label: 'Ore', default: 12},
                    grade: {type: 'string', enum: ['A', 'B', 'C']}
                });
            } else {
                try {
                    jsonEditor.set(JSON.parse(ta.value));
                } catch (e) {
                    // Se il JSON salvato era corrotto, mostra comunque il raw
                    jsonEditor.updateText(ta.value);
                }
            }
        })();
        // 3) (Opzionale) Sync live mentre l‚Äôutente digita, utile se hai anteprima
        //    Attenzione: fai debounce per non stressare la pagina
        let t;
        jsonEditor.on('change', () => {
            clearTimeout(t);
            t = setTimeout(() => {
                try {
                    const json = jsonEditor.get();
                    document.getElementById('variablesUserJson').value = JSON.stringify(json);
                } catch (_) {
                    // in modalit√† "code" pu√≤ essere temporaneamente invalido: ignora
                }
            }, 300);
        });
    </script>
    </body>
</div>
</html>