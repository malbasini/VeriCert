<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- SEO -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <title>Prezzi Vercert | Piani per certificati digitali verificabili con QR</title>
    <meta name="description" content="Confronta i piani Vercert per aziende: certificati digitali verificabili con QR code. Abbonamenti mensili o annuali con sconto.">
    <link rel="canonical" href="https://vercert.org/pricing">

    <!-- Assets globali (CSS/JS) -->
    <head th:replace="fragments/base :: headFragment(${title}, ${description}, '/pricing', 'noindex,nofollow')"></head>

    <!-- CSS globale app (se già incluso nel base puoi anche rimuoverlo) -->
    <link rel="stylesheet" th:href="@{/css/style.css}"/>

    <style>
        body {
            background: #0b1020;
            color: #e8ecf7;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .pricing-hero-title {
            letter-spacing: 0.03em;
        }
        .pricing-hero-subtitle {
            max-width: 560px;
            margin: 0 auto;
        }
        .pricing-card {
            border: 1px solid #1f2942;
            border-radius: 16px;
            background: radial-gradient(circle at top left, #151b3c 0, #111834 60%, #0b1020 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
            height: 100%;
        }
        .pricing-card h3 {
            letter-spacing: 0.03em;
        }
        .price {
            font-size: 2rem;
            font-weight: 700;
        }
        .subtitle {
            color: #9fb0ff;
        }
        .feature {
            color: #cfd6ff;
            font-size: 0.95rem;
        }
        .badge-plan {
            background: linear-gradient(135deg, #5b8cff, #8f5bff);
            border-radius: 999px;
            font-size: 0.75rem;
            padding: 0.25rem 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .btn-outline-light {
            border-color: #5b8cff;
            color: #e8ecf7;
        }
        .btn-outline-light:hover {
            background: #5b8cff;
            border-color: #5b8cff;
        }
        .btn-paypal {
            background: #ffc439;
            color: #1a1a1a;
            border: none;
        }
        .btn-paypal:hover {
            filter: brightness(.95);
        }
    </style>
</head>
<body>
<header th:replace="fragments/base :: navFragment"></header>

<main class="container py-5">
    <input type="hidden" id="tenantId" th:value="${tenantId}"/>

    <div class="text-center mb-4">
        <h1 class="fw-bold pricing-hero-title mb-2">Scegli il tuo piano</h1>
        <p class="subtitle pricing-hero-subtitle mb-3">
            Mensile o annuale con <strong>20% di sconto</strong> sul totale. Aggiorna il tuo piano in qualsiasi momento.
        </p>

        <!-- Toggle mensile/annuale -->
        <div class="d-inline-flex flex-wrap align-items-center justify-content-center gap-3 mb-2">
            <div class="d-inline-flex align-items-center gap-2">
                <span>Mensile</span>
                <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" th:checked="${billingAnnual}" id="billingToggle">
                </div>
                <span>Annuale <span class="badge badge-plan ms-1">-20%</span></span>
            </div>

            <!-- Toggle IVA -->
            <div class="d-inline-flex align-items-center gap-2">
                <span>IVA</span>
                <div class="form-check form-switch m-0"
                     title="Solo visivo: non influisce sull'importo inviato a Stripe/PayPal">
                    <input class="form-check-input" type="checkbox" id="vatToggle" checked>
                </div>
                <span>inclusa</span>
            </div>
        </div>

        <div id="annualBadge" class="small" style="color:#a6b3ff; display:none;">
            Prezzo mostrato al mese, <strong>fatturato annualmente (-20%)</strong>.
        </div>
        <div id="vatBadge" class="small" style="color:#a6b3ff;">
            Prezzi mostrati <strong>IVA inclusa (22%)</strong>. Il toggle è solo visivo.
        </div>
    </div>

    <!-- Cards piani -->
    <div class="row g-4">
        <th:block th:each="plan : ${items}">

            <!-- FREE -->
            <th:block th:if="${plan.getCode() == 'FREE'}">
                <div class="col-12 col-md-6 col-xl-3 d-flex">
                    <div class="pricing-card p-4 d-flex flex-column w-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="m-0">FREE</h3>
                            <span class="badge badge-plan">Inizia ora</span>
                        </div>
                        <div class="price" data-price-id="FREE">
                            €0<span class="fs-6 fw-normal price-period">/mese</span>
                        </div>
                        <p class="subtitle mt-2">Per test e uso personale.</p>
                        <ul class="list-unstyled mt-3 mb-4">
                            <li class="feature">✔ <span th:text="|${plan.getCertsPerMonth()} documenti/mese|"></span></li>
                            <li class="feature">✔ <span th:text="|${plan.getApiCallsPerMonth()} API/mese|"></span></li>
                            <li class="feature">✔ <span th:text="|${plan.getStorageMb()} MB storage|"></span></li>
                            <li class="feature">— <span th:text="${plan.isSupportPriority()}"></span></li>
                        </ul>
                        <div class="mt-auto d-grid gap-2">
                            <button onclick="activationFree()" class="btn btn-outline-light w-100">
                                Attiva GRATIS
                            </button>
                        </div>
                    </div>
                </div>
            </th:block>

            <!-- PRO -->
            <th:block th:if="${plan.getCode() == 'PRO'}">
                <div class="col-12 col-md-6 col-xl-3 d-flex">
                    <div class="pricing-card p-4 d-flex flex-column w-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="m-0">PRO</h3>
                            <span class="badge badge-plan">Più usato</span>
                        </div>
                        <div class="price" data-price-id="PRO">
                            €9,90<span class="fs-6 fw-normal price-period">/mese</span>
                        </div>
                        <p class="subtitle mt-2">Per professionisti e freelance.</p>
                        <ul class="list-unstyled mt-3 mb-4">
                            <li class="feature">✔ <span th:text="|${plan.getCertsPerMonth()} documenti/mese|"></span></li>
                            <li class="feature">
                                ✔
                                <span th:text="|${#numbers.formatInteger(plan.getApiCallsPerMonth(),0,'POINT')} API/mese|"></span>
                            </li>
                            <li class="feature">
                                ✔
                                <span th:text="|${(plan.getStorageMb()/1000)} GB storage|"></span>
                            </li>
                            <li class="feature">✔ <span th:text="${plan.isSupportPriority()}"></span></li>
                        </ul>
                        <div class="mt-auto d-grid gap-2">
                            <!-- Stripe -->
                            <form th:action="@{/api/payments/stripe/checkout-redirect}" method="post">
                                <input type="hidden" name="tenantId" th:value="${tenantId}"/>
                                <input type="hidden" name="amountMinor"
                                       th:value="${billingAnnual ? plan.getPriceAnnualCents():plan.getPriceMonthlyCents()}"
                                       data-amount-id="PRO"/>
                                <input type="hidden" name="currency" value="EUR"/>
                                <input type="hidden" name="planCode" value="PRO"/>
                                <input type="hidden" name="billingCycle" th:value="${period}">
                                <input type="hidden" name="description"
                                       value="Piano PRO (Mensile)" data-desc-id="PRO"/>
                                <button type="submit" class="btn btn-outline-light w-100">
                                    Acquista con Stripe
                                </button>
                            </form>
                            <!-- PayPal -->
                            <button class="btn btn-paypal w-100"
                                    data-plan="PRO" data-amount="990" data-desc="Piano PRO (Mensile)"
                                    th:attr="data-period=${period}"
                                    onclick="buyWithPaypal(this)">
                                Acquista con PayPal
                            </button>
                        </div>
                    </div>
                </div>
            </th:block>

            <!-- BUSINESS -->
            <th:block th:if="${plan.getCode() == 'BUSINESS'}">
                <div class="col-12 col-md-6 col-xl-3 d-flex">
                    <div class="pricing-card p-4 d-flex flex-column w-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="m-0">BUSINESS</h3>
                            <span class="badge badge-plan">Team</span>
                        </div>
                        <div class="price" data-price-id="BUSINESS">
                            €29,90<span class="fs-6 fw-normal price-period">/mese</span>
                        </div>
                        <p class="subtitle mt-2">Per piccoli team e aziende.</p>
                        <ul class="list-unstyled mt-3 mb-4">
                            <li class="feature">✔ <span th:text="|${plan.getCertsPerMonth()} documenti/mese|"></span></li>
                            <li class="feature">
                                ✔
                                <span th:text="|${#numbers.formatInteger(plan.getApiCallsPerMonth(),0,'POINT')} API/mese|"></span>
                            </li>
                            <li class="feature">
                                ✔
                                <span th:text="|${(plan.getStorageMb()/1000)} GB storage|"></span>
                            </li>
                            <li class="feature">✔ <span th:text="${plan.isSupportPriority()}"></span></li>
                        </ul>
                        <div class="mt-auto d-grid gap-2">
                            <form th:action="@{/api/payments/stripe/checkout-redirect}" method="post">
                                <input type="hidden" name="tenantId" th:value="${tenantId}"/>
                                <input type="hidden" name="amountMinor"
                                       th:value="${billingAnnual ? plan.getPriceAnnualCents():plan.getPriceMonthlyCents()}"
                                       data-amount-id="BUSINESS"/>
                                <input type="hidden" name="currency" value="EUR"/>
                                <input type="hidden" name="planCode" value="BUSINESS"/>
                                <input type="hidden" name="billingCycle" th:value="${period}">
                                <input type="hidden" name="description"
                                       value="Piano BUSINESS (Mensile)" data-desc-id="BUSINESS"/>
                                <button type="submit" class="btn btn-outline-light w-100">
                                    Acquista con Stripe
                                </button>
                            </form>
                            <button class="btn btn-paypal w-100"
                                    data-plan="BUSINESS" data-amount="2990" data-desc="Piano BUSINESS (Mensile)"
                                    th:attr="data-period=${period}"
                                    onclick="buyWithPaypal(this)">
                                Acquista con PayPal
                            </button>
                        </div>
                    </div>
                </div>
            </th:block>

            <!-- ENTERPRISE -->
            <th:block th:if="${plan.getCode() == 'ENTERPRISE'}">
                <div class="col-12 col-md-6 col-xl-3 d-flex">
                    <div class="pricing-card p-4 d-flex flex-column w-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="m-0">ENTERPRISE</h3>
                            <span class="badge badge-plan">Scalabilità</span>
                        </div>
                        <div class="price" data-price-id="ENTERPRISE">
                            €99,90<span class="fs-6 fw-normal price-period">/mese</span>
                        </div>
                        <p class="subtitle mt-2">Per grandi volumi e SLA dedicati.</p>
                        <ul class="list-unstyled mt-3 mb-4">
                            <li class="feature">
                                ✔
                                <span th:text="|${#numbers.formatInteger(plan.getCertsPerMonth(),0,'POINT')} documenti/mese|"></span>
                            </li>
                            <li class="feature">
                                ✔
                                <span th:text="|${#numbers.formatInteger(plan.getApiCallsPerMonth(),0,'POINT')} chiamate API/mese|"></span>
                            </li>
                            <li class="feature">
                                ✔
                                <span th:text="|${(plan.getStorageMb()/1000)} GB storage|"></span>
                            </li>
                            <li class="feature">✔ <span th:text="${plan.isSupportPriority()}"></span></li>
                        </ul>
                        <div class="mt-auto d-grid gap-2">
                            <form th:action="@{/api/payments/stripe/checkout-redirect}" method="post">
                                <input type="hidden" name="tenantId" th:value="${tenantId}"/>
                                <input type="hidden" name="amountMinor"
                                       th:value="${billingAnnual ? plan.getPriceAnnualCents():plan.getPriceMonthlyCents()}"
                                       data-amount-id="ENTERPRISE"/>
                                <input type="hidden" name="currency" value="EUR"/>
                                <input type="hidden" name="planCode" value="ENTERPRISE"/>
                                <input type="hidden" name="description"
                                       value="Piano ENTERPRISE (Mensile)" data-desc-id="ENTERPRISE"/>
                                <input type="hidden" name="billingCycle" th:value="${period}">
                                <button type="submit" class="btn btn-outline-light w-100">
                                    Acquista con Stripe
                                </button>
                            </form>

                            <button class="btn btn-paypal w-100"
                                    data-plan="ENTERPRISE" data-amount="9990"
                                    data-desc="Piano ENTERPRISE (Mensile)"
                                    th:attr="data-period=${period}"
                                    onclick="buyWithPaypal(this)">
                                Acquista con PayPal
                            </button>
                        </div>
                    </div>
                </div>
            </th:block>

        </th:block>
    </div>

    <p class="text-center mt-4" style="color:#a6b3ff;">
        * Lo sconto annuale è applicato al totale di 12 mesi.
    </p>

    <!-- BLOCCO TESTO SEO (minimo impatto) -->
    <section class="container mt-5">
        <h2 class="fw-semibold">Prezzi e piani per aziende</h2>
        <p class="subtitle">
            I piani Vercert sono pensati per aziende che vogliono <strong>creare e verificare certificati digitali</strong>
            con <strong>QR code</strong>. La verifica online consente di confermare autenticità e stato del certificato,
            riducendo errori e falsificazioni.
        </p>
        <p class="feature">
            Puoi scegliere un piano mensile o annuale. Se aumentano volumi e utilizzo, puoi aggiornare il piano in qualsiasi momento.
        </p>
        <p class="mt-2">
            Scopri di più:
            <a href="/come-funziona">Come funziona</a> ·
            <a href="/faq">FAQ</a>
        </p>

        <!-- Schema (facoltativo, minimale) -->
        <script type="application/ld+json">
            {
                "@context":"https://schema.org",
                "@type":"SoftwareApplication",
                "name":"Vercert",
                "applicationCategory":"BusinessApplication",
                "operatingSystem":"Web",
                "url":"https://vercert.org/pricing",
                "offers":{
                    "@type":"AggregateOffer",
                    "priceCurrency":"EUR",
                    "offerCount":"4"
                }
            }
        </script>
    </section>

</main>

<!-- SCRIPT JS (i tuoi) -->
<script th:inline="javascript">
    const TENANT_ID = document.getElementById('tenantId').value;
    const monthly = { FREE: 0, PRO: 990, BUSINESS: 2990, ENTERPRISE: 9990 };
    const DISCOUNT = 0.20;
    const VAT_RATE = 0.22;
    let annualMode = false;
    let vatIncluded = true;

    const fmt = cents => (cents/100).toLocaleString('it-IT', { style:'currency', currency:'EUR' });

    function displayCentsFrom(baseCents) {
        const withVat = vatIncluded ? Math.round(baseCents * (1 + VAT_RATE)) : baseCents;
        return withVat;
    }

    function refreshPrices() {
        document.getElementById('annualBadge').style.display = annualMode ? 'block' : 'none';
        document.getElementById('vatBadge').innerHTML =
            `Prezzi mostrati <strong>IVA ${vatIncluded ? 'inclusa' : 'esclusa'} (${Math.round(VAT_RATE*100)}%)</strong>. Il toggle è solo visivo.`;

        document.querySelectorAll('.price-period').forEach(el => el.textContent = '/mese');

        Object.keys(monthly).forEach(plan => {
            const priceEl   = document.querySelector(`[data-price-id="${plan}"]`);
            const amountInp = document.querySelector(`[data-amount-id="${plan}"]`);
            const descInp   = document.querySelector(`[data-desc-id="${plan}"]`);
            const ppBtn     = document.querySelector(`button.btn-paypal[data-plan="${plan}"]`);

            const monthNet = monthly[plan];

            if (!annualMode) {
                const show = displayCentsFrom(monthNet);
                if (priceEl) priceEl.innerHTML = `${fmt(show)}<span class="fs-6 fw-normal price-period">/mese</span>`;
                if (amountInp) amountInp.value = monthNet;
                if (descInp)   descInp.value   = `Piano ${plan} (Mensile)`;
                if (ppBtn) {
                    ppBtn.setAttribute('data-amount', String(monthNet));
                    ppBtn.setAttribute('data-desc',   `Piano ${plan} (Mensile)`);
                }
            } else {
                const annualTotalNet = Math.round(monthNet * 12 * (1 - DISCOUNT));
                const monthlyAvgNet  = Math.round(annualTotalNet / 12);
                const show = displayCentsFrom(monthlyAvgNet);
                if (priceEl) priceEl.innerHTML = `${fmt(show)}<span class="fs-6 fw-normal price-period">/mese</span>`;
                if (amountInp) amountInp.value = annualTotalNet;
                if (descInp)   descInp.value   = `Piano ${plan} (Annuale -20%)`;
                if (ppBtn) {
                    ppBtn.setAttribute('data-amount', String(annualTotalNet));
                    ppBtn.setAttribute('data-desc',   `Piano ${plan} (Annuale -20%)`);
                }
            }
        });
    }

    const vatToggle = document.getElementById('vatToggle');
    vatToggle.addEventListener('change', e => { vatIncluded = e.target.checked; refreshPrices(); });

    const billingToggle = document.getElementById('billingToggle').checked;
    annualMode = billingToggle;
    refreshPrices();

    async function buyWithPaypal(btn) {
        const tenantId    = document.getElementById('tenantId').value;
        const amountMinor = btn.getAttribute('data-amount');
        const description = btn.getAttribute('data-desc');
        const billingCycle = btn.getAttribute('data-period');
        const planCode    = btn.getAttribute('data-plan');
        const vat         = vatIncluded ? true : false;

        const params = new URLSearchParams({
            tenantId: tenantId,
            amountMinor: amountMinor,
            currency: 'EUR',
            description: description,
            planCode: planCode,
            billingCycle: billingCycle,
            vat: vat
        });

        try {
            const res = await fetch(`/api/payments/paypal/order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });

            if (res.status === 403) {
                let msg = 'Non hai i permessi per completare questo pagamento.';
                showToast(msg, { colorClass: 'bg-danger' , autohide: false});
                return;
            }

            if (!res.ok) {
                let msg = 'Errore ' + res.status + ' durante il pagamento.';
                try {
                    const text = await res.text();
                    if (text && text.trim().length > 0) msg = text;
                } catch (_) {}
                showToast(msg, { colorClass: 'bg-danger' });
                return;
            }

            const data = await res.json();
            if (!data.approveUrl) {
                showToast('Risposta PayPal non valida: manca approveUrl.', { colorClass: 'bg-danger' });
                return;
            }

            window.location.href = data.approveUrl;
        } catch (e) {
            showToast('Errore di rete durante il pagamento: ' + e.message, { colorClass: 'bg-danger' });
        }
    }
    window.buyWithPaypal = buyWithPaypal;
</script>

<script>
    document.getElementById('billingToggle').addEventListener('change', async (e) => {
        const annual = e.target.checked;
        await fetch('/pricing/billing?annual=' + annual, { method: 'POST' });
        annualMode = annual;
        refreshPrices();
        window.location.reload();
    });

    async function activationFree(){
        const tenantId = document.getElementById('tenantId').value;
        const response = await fetch(`/api/payments/activate-free`,{
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tenantId: tenantId })
        });
        if (!response.ok) {
            if (response.status === 403) {
                let msg = 'Non hai i permessi per completare questa operazione.';
                showToast(msg, {colorClass: 'bg-danger', autohide: false});
                return;
            }
        } else {
            showToast("Attivazione avvenuta con successo", {colorClass: 'bg-success'});
        }
    }
</script>
</body>
<div th:replace="fragments/footer :: footerFragment"></div>
</html>
