<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <head th:replace="fragments/base :: headFragment(${title}, ${description}, '/vui', 'noindex,nofollow')">
        <title>Verifica certificati digitali con QR code | Vercert</title>
    </head>
    <title>Verifica certificati digitali con QR code | Vercert</title>
    <!-- Se non lo stai già includendo in base/header, aggiungi Bootstrap CSS -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->
    <style>
        /* Piccolo “touch” senza rompere bootstrap */
        .verify-hero {
            background: radial-gradient(1200px 600px at 20% -20%, rgba(13,110,253,.22), transparent 60%),
            radial-gradient(900px 500px at 120% 10%, rgba(111,66,193,.18), transparent 60%);
        }
        .card-soft {
            border: 1px solid rgba(0,0,0,.06);
            box-shadow: 0 12px 28px rgba(0,0,0,.08);
            border-radius: 18px;
            overflow: hidden;
        }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .k { color: #6c757d; font-size: .9rem; }
        .v { font-weight: 600; }
        .skeleton { background: linear-gradient(90deg, #f1f3f5, #e9ecef, #f1f3f5); background-size: 200% 100%; animation: sk 1.2s ease-in-out infinite; border-radius: 10px; }
        @keyframes sk { 0% {background-position: 200% 0} 100% {background-position: -200% 0} }
        .skeleton-line { height: 14px; margin: 8px 0; }
        .btn-ghost { border: 1px solid rgba(0,0,0,.12); }
    </style>
</head>

<body class="bg-light verify-hero">
<header th:replace="fragments/base :: navFragment"></header>

<main class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <div class="card card-soft">
                <div class="card-header bg-white border-0 p-4 pb-0">
                    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3">
                        <div>
                            <h1 class="h4 mb-1">Verifica certificati digitali con QR code</h1>
                            <div class="text-muted small">Controllo pubblico di validità e dettagli di rilascio.</div>
                        </div>
                        <div id="statusBadge" class="badge text-bg-secondary rounded-pill px-3 py-2">
                            In attesa…
                        </div>
                    </div>
                    <hr class="mt-4 mb-0">
                </div>

                <div class="card-body p-4">
                    <div id="result">
                        <!-- Skeleton loading -->
                        <div class="mb-3">
                            <div class="skeleton skeleton-line" style="width: 55%"></div>
                            <div class="skeleton skeleton-line" style="width: 75%"></div>
                            <div class="skeleton skeleton-line" style="width: 62%"></div>
                        </div>
                        <div class="row g-3">
                            <div class="col-12 col-md-6"><div class="skeleton skeleton-line"></div></div>
                            <div class="col-12 col-md-6"><div class="skeleton skeleton-line"></div></div>
                            <div class="col-12 col-md-6"><div class="skeleton skeleton-line"></div></div>
                            <div class="col-12 col-md-6"><div class="skeleton skeleton-line"></div></div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 flex-wrap mt-4">
                        <a href="https://app.vercert.org" class="btn btn-primary">Vai al portale</a>
                        <button id="retryBtn" class="btn btn-ghost" type="button" style="display:none;">Riprova</button>
                    </div>
                    <hr class="mt-4">
                    <div class="mt-3" th:if="${signature != null}">
                          <span class="badge rounded-pill"
                                th:classappend="${signature.ok} ? 'bg-success' : 'bg-danger'">
                            <i class="bi bi-pen me-1"></i>
                            <span th:text="${signature.ok} ? 'Firma digitale valida' : 'Firma digitale non valida'"></span>
                          </span>
                          <div class="small text-muted mt-2" th:if="${signature.signerCn != null}">
                            Firmato da: <strong th:text="${signature.signerCn}">Tenant</strong>
                            <span th:if="${signature.signingTime != null}">
                             · Data firma: <span th:text="${signature.signingTime}">-</span>
                            </span>
                          </div>
                </div>
                <div class="text-muted small mt-3">
                        Se hai dubbi, contatta l’assistenza indicata nel portale.
                </div>
              </div>
            </div>
        </div>
    </div>
</main>
<script>
    function escapeHtml(s) {
        if (s === null || s === undefined) return '';
        return String(s)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    function setBadge(kind, text) {
        const el = document.getElementById('statusBadge');
        el.className = 'badge rounded-pill px-3 py-2 ';
        if (kind === 'ok') el.className += 'text-bg-success';
        else if (kind === 'warn') el.className += 'text-bg-warning';
        else if (kind === 'err') el.className += 'text-bg-danger';
        else el.className += 'text-bg-secondary';
        el.textContent = text;
    }

    function renderError(message) {
        const resultEl = document.getElementById('result');
        resultEl.innerHTML = `
      <div class="alert alert-danger mb-0">
        <div class="fw-bold">Verifica non completata</div>
        <div class="small mt-1">${escapeHtml(message)}</div>
      </div>
    `;
        document.getElementById('retryBtn').style.display = 'inline-block';
    }
    function renderOk(data) {
          const resultEl = document.getElementById('result');
          const signatureOk = !!data.signatureOk;
          const signerCn = escapeHtml(data.signerCn ?? '');
          const signedAt = escapeHtml(data.signedAt ?? '');
          const sigBadge = `
          <div class="mt-3">
            <span class="badge rounded-pill px-3 py-2 ${signatureOk ? 'text-bg-success' : 'text-bg-danger'}">
              <i class="bi bi-pen me-1"></i>
              ${signatureOk ? 'Firma digitale valida' : 'Firma digitale non valida'}
            </span>
            ${signerCn ? `<div class="small text-muted mt-2">Firmato da: <strong>${signerCn}</strong>${signedAt ? ` · Data firma: ${signedAt}` : ''}</div>` : ''}
          </div>
        `;
        resultEl.innerHTML = `
          <div class="alert alert-success mb-0">
            <div class="fw-bold">Certificato valido ✅</div>
          </div>
          ${sigBadge}
          <br>
          <div class="row g-3"></div>
        `;

    }
    async function load() {
        document.getElementById('retryBtn').style.display = 'none';
        setBadge('neutral', 'Verifica in corso…');

        const path = window.location.pathname;
        const parts = path.split('/').filter(Boolean);
        const code = parts[parts.length - 1];

        if (!code) {
            setBadge('err', 'Errore');
            renderError('Codice non specificato.');
            return;
        }

        try {
            const response = await fetch(`/v/${encodeURIComponent(code)}`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin'
            });

            let data = null;
            try { data = await response.json(); } catch (_) {}

            if (!response.ok) {
                const msg = (data && (data.error || data.message)) ? (data.error || data.message) : (response.status + ' ' + response.statusText);
                setBadge('err', 'Non valido');
                renderError(msg);
                return;
            }

            setBadge('ok', 'Verifica completata');
            renderOk(data);

        } catch (e) {
            setBadge('err', 'Errore');
            renderError('Errore di rete: ' + (e?.message ?? 'imprevisto'));
        }
    }
    document.getElementById('retryBtn').addEventListener('click', load);
    load();
</script>
</body>
</html>
