<div th:fragment="content(page, q,status,from,to,tenantId)">
    <div class="container py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h3 mb-0">Certificati</h1>
            <a class="btn btn-primary" th:href="@{/admin/certificates/new}"><i class="fa-solid fa-plus"></i>&nbsp;Nuovo certificato</a>
        </div>
        <br>
        <div id="div1"  class="alert alert-success alert-dismissible fade show" style="visibility: hidden" role="alert">
            Certificato eliminato con successo.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <br>
        <!-- Filtri -->
        <form class="row gy-2 gx-2 align-items-end mb-3" method="get">
            <div class="input-group w-auto">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" name="q" placeholder="serial / email / intestatario" th:value="${q}" >
            </div>
            <div class="col-sm-2">
                <label class="form-label">Stato</label>
                <select class="form-select" name="status">
                    <option th:selected="${status == null}" value="">Tutti</option>
                    <option th:selected="${status?.name() == 'ISSUED'}"  value="ISSUED">Emessi</option>
                    <option th:selected="${status?.name() == 'REVOKED'}" value="REVOKED">Revocati</option>
                </select>
            </div>

            <div class="col-sm-2">
                <label class="form-label">Da</label>
                <input type="date" class="form-control" name="from" th:value="${from}">
            </div>
            <div class="col-sm-2">
                <label class="form-label">A</label>
                <input type="date" class="form-control" name="to" th:value="${to}">
            </div>
            <div class="col-sm-3">
                <button class="btn btn-dark flex-fill" type="submit"><i class="fa-regular fa-circle-up"></i>&nbsp;Applica</button>
                <a class="btn btn-outline-secondary flex-fill" th:href="@{/admin/certificates}"><i class="fa-regular fa-rectangle-list"></i>&nbsp;Reset</a>
            </div>
        </form>

        <!-- Tabella -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Seriale</th>
                            <th>Intestatario</th>
                            <th>Emesso il</th>
                            <th>Stato</th>
                            <th class="text-end">Azioni</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.isEmpty(page.content)}">
                            <td colspan="6" class="text-center text-muted py-4">Nessun certificato trovato.</td>
                        </tr>
                        <tr th:each="c : ${page.content}">
                            <td th:text="${c.serial}">SERIAL</td>
                            <td>
                                <div class="fw-semibold" th:text="${c.ownerName}">Nome Cognome</div>
                                <div class="text-muted small" th:text="${c.ownerEmail}">email@example.com</div>
                            </td>
                            <td th:text="${#dates.format(T(java.util.Date).from(T(java.time.Instant).ofEpochMilli(c.issuedAt)),'dd/MM/yyyy HH:mm')}"></td>
                            <td>
                        <span class="badge rounded-pill"
                              th:classappend="${c.status?.name()=='REVOKED'} ? ' text-bg-danger' : ' text-bg-success'"
                              th:text="${c.status?.name()=='REVOKED'} ? 'Revocato' : 'Valido'">Valido</span>
                            </td>

                            <td class="text-end">
                                <a th:if="${c.pdfUrl != null}" th:href="@{/files/{t}/{f}(t=${tenantId}, f=${c.serial + '.pdf'})}"
                                   target="_blank" class="btn btn-sm btn-outline-primary me-2"><i class="fa-regular fa-file-pdf"></i>PDF</a>
                                <a th:href="@{'/admin/certificates/' + ${c.id} + '/detail'}"
                                   class="btn btn-sm btn-outline-secondary me-2"><i class="fa-solid fa-info"></i>&nbsp;&nbsp;Dettaglio</a>
                                <th:block th:if="${c.status?.name()=='REVOKED'}">
                                    <a class="js-del btn btn-outline-danger btn-sm rounded" data-bs-toggle="modal" data-bs-target="#deleteCertificateModal"  th:data-certificate-id="${c.id}">
                                        <i class="bi bi-trash"></i> Elimina
                                    </a>
                                </th:block>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal fade" id="deleteCertificateModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content center">
                            <div class="modal-header">
                                <h5 class="modal-title">Conferma eliminazione</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body">
                                Eliminando il certificato verranno rimosse le righe nel database e cancellato il file su disco. L'operazione è irreversibile. Continuare?
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Elimina</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <!-- Pagination -->
        <nav th:if="${page.totalPages > 1}">
            <ul class="pagination mb-0">
                <li class="page-item" th:classappend="${page.first} ? ' disabled'">
                    <a class="page-link" th:href="@{/admin/certificates(page=${page.number-1}, size=${page.size}, q=${q}, status=${status}, from=${from}, to=${to})}">«</a>
                </li>
                <li class="page-item" th:each="n : ${#numbers.sequence(0, page.totalPages-1)}"
                    th:classappend="${n==page.number} ? ' active'">
                    <a class="page-link" th:text="${n+1}" th:href="@{/admin/certificates(page=${n}, size=${page.size}, q=${q}, status=${status}, from=${from}, to=${to})}">1</a>
                </li>
                <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/admin/certificates(page=${page.number+1}, size=${page.size}, q=${q}, status=${status}, from=${from}, to=${to})}">»</a>
                </li>
            </ul>
        </nav>
        <script>
            const modalEl = document.getElementById('deleteCertificateModal');
            const confirmBtn = document.getElementById('confirmDeleteBtn');

            modalEl.addEventListener('show.bs.modal', (event) => {
                const trigger = event.relatedTarget; // bottone che ha aperto la modale
                const certificateId = trigger.getAttribute('data-certificate-id');
                // salva l'id sul bottone di conferma (o sulla modale)
                confirmBtn.dataset.certificateId = certificateId;
            });

            confirmBtn.addEventListener('click', async () => {
                const id = confirmBtn.dataset.certificateId;
                if (!id) return;
                const resp = await fetch(`/api/certificates/${encodeURIComponent(id)}/delete`, { method: 'DELETE' });
                const data = await resp.json();
                if (resp.ok) {
                    // chiudi modale e aggiorna pagina/lista
                    hideModal()
                    sessionStorage.setItem("flashMsg", JSON.stringify({ text: "Certificato eliminato con successo", cls: "bg-success" }));
                    location.reload();
                } else {
                    // gestisci errore
                    sessionStorage.setItem("flashMsg", JSON.stringify({ text: data?.message + ` Status HTTP ${resp.status}`, cls: "bg-danger" }));
                    return;
                }

                function hideModal() {
                    const instance = bootstrap.Modal.getOrCreateInstance(modalEl);
                    instance.hide();
                }
            });

        </script>
        <script>
            // all'avvio pagina (es. in uno script al fondo pagina):
            const flash = sessionStorage.getItem("flashMsg");
            if (flash) {
                const { text, cls } = JSON.parse(flash);
                showToast(text, { colorClass: cls });
                sessionStorage.removeItem("flashMsg");
            }
        </script>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</div>