<!DOCTYPE html>
<html lang="it"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- CSRF meta -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>Login Â· VeriCert</title>
    <head th:replace="fragments/base :: headFragment(${title}, ${description}, '/login', 'noindex,nofollow')"></head>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>

    <style>
        body {
            min-height: 100vh;
            margin: 0;
            background: radial-gradient(circle at top left, #f5f7ff 0, #f5f5f7 40%, #eef2f7 100%);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .auth-container {
            min-height: calc(100vh - 80px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        .auth-card {
            width: 100%;
            max-width: 420px;
            background: #ffffff;
            border-radius: 1.25rem;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.15);
            padding: 2.25rem 2.5rem;
        }
        .auth-title {
            font-size: 1.6rem;
            font-weight: 600;
        }
        .auth-subtitle {
            color: #6c757d;
            font-size: 0.95rem;
        }
        .brand-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            background: #eff2ff;
            color: #3949ab;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body>
<header th:replace="fragments/base :: navFragment"></header>
<div class="auth-container">
    <div class="auth-card">

        <div class="brand-pill">
            <span>VeriCert</span>
        </div>

        <h1 class="auth-title mb-1">Accedi al tuo account</h1>
        <p class="auth-subtitle mb-4">
            Inserisci le tue credenziali per continuare.
        </p>

        <!-- Messaggi da Spring Security (logout, error, ecc.) -->
        <div th:if="${param.logout != null}" class="alert alert-success py-2" role="alert">
            Logout effettuato con successo.
        </div>
        <div th:if="${param.error != null}" class="alert alert-danger py-2" role="alert">
            Credenziali non valide. Riprova.
        </div>

        <!-- Form "finto" gestito da JS, ma semantico -->
        <form onsubmit="login(); return false;" novalidate>
            <!-- CSRF -->
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>

            <div class="mb-3">
                <label for="username" class="form-label">Username o email</label>
                <input type="text"
                       class="form-control"
                       id="username"
                       placeholder="Inserisci username o email"
                       autocomplete="username"
                       required>
            </div>

            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <label for="password" class="form-label mb-0">Password</label>
                    <!-- eventuale link recupero -->
                    <!-- <a href="#" class="small text-decoration-none">Password dimenticata?</a> -->
                </div>
                <input type="password"
                       class="form-control"
                       id="password"
                       placeholder="Inserisci la password"
                       autocomplete="current-password"
                       required>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">
                        Ricordami
                    </label>
                </div>
                <a th:href="@{/signup}" class="small text-decoration-none">
                    Non hai un account? Registrati
                </a>
            </div>

            <button type="submit" class="btn btn-primary w-100">
                Accedi
            </button>
        </form>
    </div>
</div>
<script>
    async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const remember = document.getElementById("rememberMe").checked;

        const token = document.querySelector('meta[name="_csrf"]').content;
        const headerName = document.querySelector('meta[name="_csrf_header"]').content;

        const params = new URLSearchParams();
        params.append("username", username);
        params.append("password", password);
        params.append("rememberMe", remember);

        const res = await fetch("/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                [headerName]: token
            },
            body: params.toString()
        });

        if (res.redirected) {
            window.location.href = "/";
            return;
        }

        if (!res.ok) {
            showToast('Errore nel login (' + res.status + ')', { colorClass: 'bg-danger', autohide: true });
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
</body>
</html>