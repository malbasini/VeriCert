<!DOCTYPE html>
<html lang="it"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Registrazione · VeriCert</title>

    <head th:replace="fragments/base :: headFragment(${title}, ${description}, '/signup', 'noindex,nofollow')"></head>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>

    <style>
        body {
            min-height: 100vh;
            margin: 0;
            background: radial-gradient(circle at top left, #f5f7ff 0, #f5f5f7 40%, #eef2f7 100%);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .auth-container {
            min-height: calc(100vh - 80px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        .auth-card {
            width: 100%;
            max-width: 500px;
            background: #ffffff;
            border-radius: 1.25rem;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.15);
            padding: 2.25rem 2.5rem;
        }
        .auth-title {
            font-size: 1.6rem;
            font-weight: 600;
        }
        .auth-subtitle {
            color: #6c757d;
            font-size: 0.95rem;
        }
        .brand-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            background: #eff2ff;
            color: #3949ab;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.75rem;
        }
        .captcha-wrapper {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
<header th:replace="fragments/base :: navFragment"></header>
<div class="auth-container">
    <div class="auth-card">

        <div class="brand-pill">
            <span>VeriCert</span>
        </div>

        <h1 class="auth-title mb-1">Crea un nuovo account</h1>
        <p class="auth-subtitle mb-4">
            Registra il tuo tenant per iniziare a emettere e verificare certificati digitali.
        </p>

        <form onsubmit="signup(); return false;" novalidate>

            <div class="mb-3">
                <label for="fullname" class="form-label">Full Name</label>
                <input type="text"
                       id="fullname"
                       name="fullname"
                       class="form-control"
                       placeholder="Full Name"
                       required>
            </div>
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text"
                       id="username"
                       name="username"
                       class="form-control"
                       placeholder="Scegli uno username"
                       required>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password"
                       id="password"
                       name="password"
                       class="form-control"
                       placeholder="Scegli una password sicura"
                       required>
            </div>

            <div class="mb-3">
                <label for="tenant" class="form-label">Nome tenant</label>
                <input type="text"
                       id="tenant"
                       name="nometenant"
                       class="form-control"
                       placeholder="Es. Studio Rossi, Azienda ABC"
                       required>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email"
                       id="email"
                       name="email"
                       class="form-control"
                       placeholder="esempio@dominio.it"
                       required>
            </div>

            <!-- reCAPTCHA -->
            <div class="mb-4 captcha-wrapper">
                <div class="g-recaptcha"
                     th:attr="data-sitekey=${@captchaSettings.getSite()}"></div>
            </div>

            <button type="submit" class="btn btn-primary w-100">
                Registrati
            </button>

            <p class="small text-center text-muted mt-3 mb-0">
                Hai già un account?
                <a th:href="@{/login}" class="text-decoration-none">Accedi</a>
            </p>
        </form>
    </div>
</div>

<script>
    async function signup() {
        const fullname = document.getElementById("fullname").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const tenant   = document.getElementById("tenant").value;
        const email    = document.getElementById("email").value;
        const captchaToken =
            document.querySelector('textarea[name="g-recaptcha-response"]')?.value || '';

        const res = await fetch(`/signup`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fullname: fullname,
                username: username,
                password: password,
                email: email,
                tenantName: tenant,
                captchaToken: captchaToken
            })
        });

        const contentType = res.headers.get('Content-Type') || '';
        const body = contentType.includes('application/json') ? await res.json() : null;

        if (!res.ok) {
            if (body?.errors !== undefined) {
                renderValidationErrors(body?.errors);
                return;
            }
            else{
                showToast(body?.message ,{colorClass: 'bg-danger', autohide: true});
                return;
            }
        }
        showToast('Utente creato', { colorClass: 'bg-success', autohide: true });
    }

    function renderValidationErrors(errors) {
        if (!errors || typeof errors !== 'object') {
            showToast('Si è verificato un errore di validazione.');
            return;
        }

        const items = Object.entries(errors).flatMap(([field, messages]) => {
            const list = Array.isArray(messages) ? messages : [String(messages)];
            return list.map(msg => `<li>${escapeHtml(field)}: ${escapeHtml(msg)}</li>`);
        });

        const html = `
      <div>
        <strong>Validazione fallita</strong>
        <ul class="mb-0 ps-3">
          ${items.join('')}
        </ul>
      </div>
    `;

        showToast(html, { colorClass: 'bg-danger', autohide: true });
    }

    function escapeHtml(s) {
        return String(s)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
</body>
</html>
