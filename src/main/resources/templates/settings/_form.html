<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org" th:fragment="content(form,usage,tenantId,billingProfile,saved)">
<body class="bg-light">

<div class="container my-4">
    <!-- Alert di salvataggio -->
    <div th:if="${saved}" class="alert alert-success alert-dismissible fade show" role="alert">
        Impostazioni salvate con successo.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <h1 class="h3 mb-3">
        <b>Impostazioni organizzazione</b>
        <br>
        <hr>
        <small class="text-muted d-block" th:text="${#authentication.principal.tenantName}">TenantName</small>
    </h1>
    <ul class="nav nav-tabs mb-3" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-profile"
                    type="button" role="tab">Profilo</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-branding"
                    type="button" role="tab">Branding certificati</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-usage"
                    type="button" role="tab">
                Utilizzo & limiti
            </button>
        </li>
        <li class="nav-item ms-auto" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-supplier"
                    type="button" role="tab">
                Fornitore
            </button>
        </li>
    </ul>
    <form method="post" th:action="@{/admin/settings/save}" th:object="${form}">
        <div class="tab-content border rounded p-3 bg-white">
            <!-- PROFILO -->
            <div class="tab-pane fade show active" id="tab-profile" role="tabpanel">
                <div class="mb-3">
                    <label class="form-label">Ragione sociale / Nome pubblico</label>
                    <input class="form-control" th:field="*{displayName}">
                    <div class="text-danger small" th:if="${#fields.hasErrors('displayName')}"
                         th:errors="*{displayName}">Err
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Email di contatto</label>
                    <input class="form-control" th:field="*{contactEmail}">
                    <div class="text-danger small" th:if="${#fields.hasErrors('contactEmail')}"
                         th:errors="*{contactEmail}">Err
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Sito web</label>
                    <input class="form-control" th:field="*{website}">
                </div>
            </div>
            <!-- BRANDING -->
            <div class="tab-pane fade" id="tab-branding" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">

                        <div class="mb-3">
                            <label class="form-label">Nome firmatario</label>
                            <input class="form-control" th:field="*{issuerName}">
                            <div class="text-danger small" th:if="${#fields.hasErrors('issuerName')}"
                                 th:errors="*{issuerName}">Err
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ruolo firmatario</label>
                            <input class="form-control" th:field="*{issuerRole}">
                            <div class="text-danger small" th:if="${#fields.hasErrors('issuerRole')}"
                                 th:errors="*{issuerRole}">Err
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Colore primario (brand)</label>
                            <input class="form-control" th:field="*{primaryColor}" placeholder="#0d6efd">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Template di default</label>
                            <input class="form-control" th:field="*{defaultTemplateId}"
                                   placeholder="ID template attivo">
                            <div class="form-text">
                                Usato in fase di emissione certificato.
                            </div>
                        </div>

                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Logo URL</label>
                            <input class="form-control" th:field="*{logoUrl}" readonly>
                            <div class="form-text">Mostrato nel PDF in alto a sinistra.</div>
                            <!-- Upload Logo -->
                            <div class="mt-2">
                                <input type="file" id="logoFileInput" accept="image/*" class="d-none">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="document.getElementById('logoFileInput').click()">
                                    <i class="bi bi-upload"></i>&nbsp Carica Logo
                                </button>
                                <span id="logoUploadStatus" class="ms-2 small"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Firma digitale URL</label>
                            <input class="form-control" th:field="*{signatureImageUrl}" readonly>
                            <div class="form-text">PNG trasparente della firma, se disponibile.</div>
                            <!-- Upload Signature -->
                            <div class="mt-2">
                                <input type="file" id="signatureFileInput" accept="image/*" class="d-none">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="document.getElementById('signatureFileInput').click()">
                                    <i class="bi bi-upload"></i>&nbsp Carica Firma
                                </button>
                                <span id="signatureUploadStatus" class="ms-2 small"></span>
                            </div>
                        </div>
                        <!-- mini anteprima -->
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex align-items-center">
                                <img id="logoPreview" th:src="*{logoUrl}"  th:alt="*{logoUrl}" style="max-height:60px;">
                            </div>
                            <div>
                                <div class="fw-semibold" th:text="*{issuerName}">Mario Rossi</div>
                                <div class="text-muted small" th:text="*{issuerRole}">Direttore Formazione</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <img id="signaturePreview" th:src="*{signatureImageUrl}" alt="signature preview" style="max-height:60px;">
                        </div>
                    </div>
                </div>
            </div>
            <!-- USAGE -->
            <div class="tab-pane fade" id="tab-usage" role="tabpanel">
                <div class="row g-4">
                    <p>Piano: <b th:text="${usage.planCode}"></b></p>
                    <p>Ciclo: <b th:text="${usage.billingCycle}"></b></p>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body">
                                <div class="text-muted small"></div>
                                <div class="fs-4 fw-semibold">
                                    Documenti: <span th:text="${#numbers.formatInteger(usage.usedCerts,0,'POINT')}"></span> / <span th:text="${#numbers.formatInteger(usage.certLimit,0,'POINT')}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-primary">
                            <div class="card-body">
                                <div class="text-muted small"></div>
                                <div class="fs-4 fw-semibold">
                                    API: <span th:text="${#numbers.formatInteger(usage.usedApi,0,'POINT')}"></span> / <span th:text="${#numbers.formatInteger(usage.apiLimit,0,'POINT')}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card border-warning">
                            <div class="card-body">
                                <div class="text-muted small"></div>
                                <div class="fs-4 fw-semibold">
                                    Storage (MB):<span th:text="${usage.usedStorage}"></span> / <span th:text="${usage.storageLimit}"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="card border-success">
                            <div class="card-body">
                                <div class="text-muted small"></div>
                                <div class="fs-4 fw-semibold">
                                    Giorni rimanenti alla scadenza del piano&nbsp<span th:text="${usage.getDaysLeft}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <b>Questi limiti dipendono dal piano del tenant.</b>
                    <br>
                </div>
            </div>
            <!-- footer form -->
            <div class="d-flex justify-content-between mt-3">
                <button id="btn" type="submit" class="btn btn-primary">
                    Salva impostazioni
                </button>
                <a href="/admin" id="btn1" class="btn btn-outline-secondary">
                    ← Torna alla dashboard
                </a>
            </div>
        </div>
    </form>
    <br>
    <hr>
    <form method="post" th:action="@{/admin/settings/profile}" th:object="${billingProfile}">
        <!-- FORNITORE / PROFILO AZIENDALE (tenant_profile) -->
        <div class="tab-pane fade" id="tab-supplier" role="tabpanel">

            <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
                <div>
                    <h3 class="h5 mb-1">Dati fornitore</h3>
                    <div class="text-muted small">
                        Anagrafica aziendale usata per fatturazione e documenti.
                    </div>
                </div>
            </div>

            <!-- Anagrafica -->
            <div class="card border-0 bg-body-tertiary mb-3">
                <div class="card-body">
                    <div class="row g-3">

                        <div class="col-12 col-lg-8">
                            <label class="form-label">Ragione sociale</label>
                            <input class="form-control" th:field="*{companyName}" placeholder="Es. VeriCert S.r.l.">
                            <div class="text-danger small" th:if="${#fields.hasErrors('companyName')}" th:errors="*{companyName}">Err</div>
                        </div>

                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label">Paese</label>
                            <select class="form-select" th:field="*{country}">
                                <option value="IT">IT</option>
                                <option value="SM">SM</option>
                                <option value="CH">CH</option>
                                <option value="FR">FR</option>
                                <option value="DE">DE</option>
                                <option value="ES">ES</option>
                            </select>
                            <div class="form-text">Codice ISO a 2 lettere.</div>
                        </div>

                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label">Partita IVA</label>
                            <input class="form-control" th:field="*{vatNumber}" placeholder="Es. IT01234567890">
                            <div class="text-danger small" th:if="${#fields.hasErrors('vatNumber')}" th:errors="*{vatNumber}">Err</div>
                        </div>

                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label">Codice fiscale</label>
                            <input class="form-control" th:field="*{taxCode}" placeholder="(se diverso dalla P.IVA)">
                            <div class="text-danger small" th:if="${#fields.hasErrors('taxCode')}" th:errors="*{taxCode}">Err</div>
                        </div>

                        <div class="col-12 col-md-6 col-lg-4">
                            <label class="form-label">Codice SDI</label>
                            <input class="form-control" th:field="*{sdiCode}" placeholder="Es. ABCD123">
                            <div class="form-text">Per fatturazione elettronica (Italia).</div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">PEC</label>
                            <input class="form-control" th:field="*{pecEmail}" placeholder="pec@azienda.it">
                            <div class="text-danger small" th:if="${#fields.hasErrors('pecEmail')}" th:errors="*{pecEmail}">Err</div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Indirizzo -->
            <div class="card border-0 bg-body-tertiary mb-3">
                <div class="card-body">
                    <div class="fw-semibold mb-2">Indirizzo</div>
                    <div class="row g-3">

                        <div class="col-12">
                            <label class="form-label">Indirizzo (riga 1)</label>
                            <input class="form-control" th:field="*{addressLine1}" placeholder="Via, numero civico">
                            <div class="text-danger small" th:if="${#fields.hasErrors('addressLine1')}" th:errors="*{addressLine1}">Err</div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Indirizzo (riga 2)</label>
                            <input class="form-control" th:field="*{addressLine2}" placeholder="Scala, interno, c/o... (opzionale)">
                        </div>

                        <div class="col-12 col-md-6 col-lg-5">
                            <label class="form-label">Città</label>
                            <input class="form-control" th:field="*{city}" placeholder="Es. Milano">
                            <div class="text-danger small" th:if="${#fields.hasErrors('city')}" th:errors="*{city}">Err</div>
                        </div>

                        <div class="col-6 col-md-3 col-lg-3">
                            <label class="form-label">Provincia</label>
                            <input class="form-control text-uppercase" th:field="*{province}" placeholder="MI">
                        </div>

                        <div class="col-6 col-md-3 col-lg-4">
                            <label class="form-label">CAP</label>
                            <input class="form-control" th:field="*{postalCode}" placeholder="20100">
                        </div>

                    </div>
                </div>
            </div>

            <!-- Contatti -->
            <div class="card border-0 bg-body-tertiary">
                <div class="card-body">
                    <div class="fw-semibold mb-2">Contatti e riferimenti</div>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label">Email supporto</label>
                            <input class="form-control" th:field="*{supportEmail}" placeholder="support@azienda.it">
                            <div class="form-text">Mostrabile nei documenti o nelle comunicazioni.</div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label">Sito web</label>
                            <input class="form-control" th:field="*{websiteUrl}" placeholder="https://...">
                        </div>
                    </div>
                </div>
            </div>
            <!-- footer form -->
            <div class="d-flex justify-content-between mt-3">
                <button id="supplier" type="submit" class="btn btn-primary">
                    Salva impostazioni
                </button>
                <a href="/admin" class="btn btn-outline-secondary">
                    ← Torna alla dashboard
                </a>
            </div>
        </div>
    </form>
</div>
<script th:if="${saved}" >
    showToast("Impostazioni salvate con successo",{ colorClass: 'bg-success'});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.getElementById('settingsTabs');
        const saveBtn = document.getElementById('btn');
        const dashboardBtn = document.getElementById('btn1');

        function toggleSave(targetId) {
            const hide = (targetId === '#tab-usage' || targetId === '#tab-supplier');
            if (hide) {
                if (targetId === '#tab-supplier') {
                    dashboardBtn.classList.add('d-none');
                    dashboardBtn.disabled = true;
                }
                saveBtn.classList.add('d-none');
                saveBtn.disabled = true;
            } else {
                if (targetId === '#tab-supplier') {
                    dashboardBtn.classList.remove('d-none');
                    dashboardBtn.disabled = false;
                }
                saveBtn.classList.remove('d-none');
                saveBtn.disabled = false;
            }
        }

        // stato iniziale (se la pagina apre su una tab specifica)
        const active = document.querySelector('#settingsTabs .nav-link.active');
        if (active && active.dataset.bsTarget) {
            toggleSave(active.dataset.bsTarget);
        }

        tabs.addEventListener('shown.bs.tab', function (e) {
            const targetId = e.target.getAttribute('data-bs-target'); // es. "#tab-usage"
            toggleSave(targetId);
        });

        // Upload handlers
        const logoInput = document.getElementById('logoFileInput');
        const signatureInput = document.getElementById('signatureFileInput');

        if (logoInput) {
            logoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file, '/admin/settings/upload-logo', 'logoUploadStatus', 'logoPreview', 'logoUrl');
                }
            });
        }

        if (signatureInput) {
            signatureInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file, '/admin/settings/upload-signature', 'signatureUploadStatus', 'signaturePreview', 'signatureImageUrl');
                }
            });
        }

        function uploadFile(file, endpoint, statusElementId, previewImageId, urlFieldId) {
            alert('upload');
            const formData = new FormData();
            formData.append('file', file);
            const statusEl = document.getElementById(statusElementId);
            const previewImg = document.getElementById(previewImageId);
            alert(previewImg);
            const urlField = document.querySelector('input[name="' + urlFieldId + '"]');

            statusEl.textContent = '⏳ Caricamento...';
            statusEl.className = 'ms-2 small text-info';

            fetch(endpoint, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success === 'true') {
                        statusEl.textContent = '✅ ' + data.message;
                        statusEl.className = 'ms-2 small text-success';

                        // Aggiorna anteprima e campo URL
                        if (previewImg) {
                            previewImg.src = data.url + '?t=' + new Date().getTime();
                            previewImg.style.display = 'block';
                        }
                        if (urlField && data.url) {
                            urlField.value = data.url;
                        }

                        // Mostra toast di successo
                        if (typeof showToast === 'function') {
                            showToast(data.message, { colorClass: 'bg-success' });
                        }

                        // Nascondi il messaggio dopo 3 secondi
                        setTimeout(() => {
                            statusEl.textContent = '';
                        }, 3000);
                    } else {
                        statusEl.textContent = '❌ ' + data.message;
                        statusEl.className = 'ms-2 small text-danger';
                    }
                })
                .catch(error => {
                    statusEl.textContent = '❌ Errore di rete';
                    statusEl.className = 'ms-2 small text-danger';
                    console.error('Upload error:', error);
                });
        }
    });

</script>
</body>
</html>